import { Bodies, Composite, Engine, Runner, Render } from 'matter-js';
import { useEffect, useRef, useState } from 'react';

const MatterDemo = () => {
  const ref = useRef<HTMLDivElement>(null);
  const dots = useRef<{ x: number; y: number }[]>([]);
  const [, setAnim] = useState(0);
  const engineRef = useRef<Engine>(Engine.create({}));
  const runnerRef = useRef<Runner>(Runner.create());
  const renderRef = useRef<Render>();
  useEffect(() => {
    if (!ref.current) return;
    const engine = engineRef.current;
    const runner = runnerRef.current;
    renderRef.current = Render.create({
      element: ref.current,
      engine: engine,

      options: {
        width: ref.current.clientWidth,
        height: ref.current.clientHeight,
        background: 'transparent',
        wireframes: false,
        pixelRatio: window.devicePixelRatio,
      },
    });
    Runner.run(runner, engine);

    return () => {
      Runner.stop(runner);
      Engine.clear(engine);
    };
  }, []);
  // Initialize the physics bodies
  useEffect(() => {
    if (!ref.current) return;
    const width = ref.current?.clientWidth ?? 0;
    const height = ref.current?.clientHeight ?? 0;

    const ground = Bodies.rectangle(width / 2, height, width, 50, {
      isStatic: true,
    });
    const ceiling = Bodies.rectangle(width / 2, 0, width, 1, {
      isStatic: true,
    });
    const wallL = Bodies.rectangle(0 - 60 / 2, height / 2, 1, height * 5, {
      render: { fillStyle: '#000' },
      isStatic: true,
    });
    const wallR = Bodies.rectangle(width, height / 2, 50, height, {
      isStatic: true,
    });

    Composite.add(engineRef.current.world, [ground, ceiling, wallL, wallR]);
  }, []);

  // Add dots to the canvas
  useEffect(() => {
    let unsubscribe: any;

    function addDot() {
      const width = ref.current?.clientWidth ?? 0;
      const height = ref.current?.clientHeight ?? 0;

      const size = 0.68 * width * (100 / width);
      console.log(size);
      const circ = Bodies.circle(
        Math.random() * width * 0.75 + size,
        Math.random() * height * 0.75 + size,
        size / 2
      );
      circ.friction = 0.05;
      circ.frictionAir = 0.00005;
      circ.restitution = 0.7;

      Composite.add(engineRef.current.world, circ);

      if (dots.current.length < 100) setTimeout(addDot, 150);
    }

    addDot();

    return () => {
      clearTimeout(unsubscribe);
    };
  }, []);

  // Animation loop
  useEffect(function triggerAnimation() {
    let unsubscribe: number;

    function animate() {
      let i = 0;
      for (const dot of Composite.allBodies(engineRef.current.world)) {
        if (dot.isStatic) continue;

        dots.current[i] = { x: dot.position.x, y: dot.position.y };

        i += 1;
      }

      setAnim(x => x + 1);

      unsubscribe = requestAnimationFrame(animate);
    }

    unsubscribe = requestAnimationFrame(animate);

    return () => {
      cancelAnimationFrame(unsubscribe);
    };
  }, []);

  return (
    <div ref={ref} className='w-full h-svh relative bg-blue-500'>
      {dots.current.map((dot, key) => (
        <div
          key={key}
          className='rounded-full shadow-md absolute w--[64] h--[65]'
          style={{ top: dot.y, left: dot.x }}>
          <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 623.82 620.44'>
            <path
              d='M145.37 44.46A332.798 332.798 0 0 1 286 .34c53.12-2.63 101.88 9.87 169.5 42.25s105 63.25 133.62 116.38 44.12 92.25 28.5 161.37-20.38 138.63-48.12 186.63-74.13 81.25-142.88 98.5-166.5 28.5-250.87-18S32 471.84 10.12 376.21s-3.87-145.38 12.5-190.25a295.524 295.524 0 0 1 122.75-141.5Z'
              style={{
                fill: '#1d1d1b',
                strokeWidth: 0,
              }}
            />
            <path
              d='M168.75 51.59a285.742 285.742 0 0 1 96.13-32.5c50-5.88 130.87 16.5 139.37 20.38s15.62 6.25 12.5 8.62S385.13 75.34 375 76.96s-45.25-7-71.88-5.88-44.5 6.25-57.38 6.25-31.25-14.13-43.75-15.25-39.13-7.38-33.25-10.5Z'
              style={{
                fill: '#4eae4d',
                strokeWidth: 0,
              }}
            />
            <path
              d='M144.12 71.09a72.742 72.742 0 0 1 52 4.25c20.25 11 18 15.62 45.62 15.25s41.13-5 49.25-3.12 42.63 16.88 73.13 11a130.152 130.152 0 0 0 53.5-21.88c9-5.88 14.38-15.62 19.88-14.87s55.12 30.12 54.25 33.25a56.571 56.571 0 0 1-21.37 18.75 92.849 92.849 0 0 0-34.88 43.25c-6.25 18.37-9.75 73.5-1.5 79s29.25-2.38 37.5 3.87 10.13 25.75 23.87 27.38 19.5-8.63 32 0 12.5 15.12 32 15.62 37.5-4 38.63 0c1.28 5.98.76 12.2-1.5 17.88-2 1.25-68 9-83.62 9.88-15.62.88-12.5 4.25-21.12 0s-22.25-20.37-42.37-23.5-81.62-7-93.75-7-15.62 0-16.87 5.87 1.25 64.75-5 84-2 50.75 20.63 59.75 46.12 13.63 49.25 21.88 14.13 62.5 23.87 80.88 23.37 39.38 18.75 43.25a253.857 253.857 0 0 1-75 19.25 295.032 295.032 0 0 1-72.25 0s-14.5-75-18.37-81.75a58.3 58.3 0 0 1-5.12-29.25c1.62-5.12 29.25-60.87 25.75-75s-9-28.5-21.88-32-34.38 0-69.13 0c-22.38.32-44.73-1.52-66.75-5.5-7-1.5-11 0-14.12-3.5s-28.5-50-25-54.25 39.12-14.5 40.62-22.75-.75-28.12 8.25-28.87 48.38 4.75 60.88-1.87 14.12-21.88 14.5-35.25-4.63-42.5-10.5-48-62.5-22.62-84-34-39.63-20.25-37.25-27.75a155.518 155.518 0 0 1 47.25-44.12Z'
              style={{
                fill: '#85bfe9',
                strokeWidth: 0,
              }}
            />
            <path
              d='M168 97.71c6.75-.87 7.38 4.38 5 9s0 21.5 7.5 21.12a693.91 693.91 0 0 1 80-13.25c34.2 1.64 67.94 8.6 100 20.62 9.38 5.12 13.75 25 14.5 30.87a367.6 367.6 0 0 1-34.38 69.13c-3.5 1.87-39.88-12.5-66-25s-37.5-18.37-38.63-23.5a78.007 78.007 0 0 0-6.25-21.13c-2.38-1.13-37.5-3.5-54.38-13.63s-32-26.63-28.87-33.63a52.155 52.155 0 0 1 21.5-20.62Z'
              style={{
                fill: '#1d1d1b',
                strokeWidth: 0,
              }}
            />
            <path
              d='M216.37 133.59c30.2-4.03 60.88-2.72 90.62 3.87 39.87 7.87 46.12 14.5 45 24.25s-16 50-21.5 48a522.633 522.633 0 0 1-66.37-27.25c-2.75-4-3.63-23.5-15.25-27s-36-11-44.13-14.12-6.25-6.25-4.38-6.25 16-1.5 16-1.5ZM506.62 100.34c2.62-.87 36.75 13.38 60.13 57.88s30.88 99.25 28.12 104.25-11.25 5.5-19.12 3.12-38.88-19.5-45.63-19.5-17.62 5.87-22.25 0-18.75-23.38-32.88-23.38-17.12 2.38-19.5-.75-10.13-69.13 4.62-81.25 27.75-19.88 33.62-25 9.38-14.13 12.87-15.37ZM358.25 297.71c4.5 0 71.5-5 84.75 7.87 13.25 12.87 24.25 26.87 35.5 26.5s114.87-9.38 114.87-5.38-11.75 93.75-29.75 139.38a198.875 198.875 0 0 1-69.12 88.25c-14.38 8.25-29.25 11.37-30.38 9a272.95 272.95 0 0 1-28.63-74.13c-8.5-40.25-10.87-59-24.13-62.5s-46.12-11.25-52.37-19.12a49.976 49.976 0 0 1-7-23.37s3.5-48.5 3.5-59 .37-27.5 2.75-27.5ZM129.75 387.84a159.242 159.242 0 0 0 60.5 11.37c41.37.75 82-3.88 86.37 1.13s3.5 22.25-5.5 38.75a268.35 268.35 0 0 0-14.88 32.38 326.855 326.855 0 0 0-39.5-31.25 7.373 7.373 0 0 0-4.25 8.62c1.62 3.5 37.5 27.75 39.13 30.88.24 7.31-.18 14.64-1.25 21.88a321.767 321.767 0 0 0-37.5-29.75c-4.63-.75-7.75 10.62-6.25 12.5s44.13 31.25 50 36.37a75.79 75.79 0 0 1 10.5 31.62c-1.13 0-48.75-38.63-51.5-39.13s-3.5 12.5-3.5 12.5 56.25 39.87 58.12 43a81.303 81.303 0 0 1 5.5 23.5 410.63 410.63 0 0 1-44.88-11.37c-15.62-5.88-29.38-9-29.38-10.13s-14.63-47.25-35.12-67.25a161.276 161.276 0 0 1-29.5-33.13c-2.39-15.4-3.85-30.93-4.38-46.5-.5-10.62-5.12-36-2.75-36Z'
              style={{
                fill: '#4eae4d',
                strokeWidth: 0,
              }}
            />
            <path
              d='M43.37 390.21c2.37-4.62 32 3.12 46.13 8.62s18.75 12.5 19.12 23.37-1.63 58.25 8.13 66.87a133.663 133.663 0 0 1 38.37 41 90.777 90.777 0 0 1 12.5 27.37 251.769 251.769 0 0 1-73.87-68.75c-39.88-51.63-51.5-96.12-50.38-98.5Z'
              style={{
                fill: '#85bfe9',
                strokeWidth: 0,
              }}
            />
            <path
              d='M32 362.46a220.724 220.724 0 0 1-1.5-120.62c17.12-71.13 50-109 52.75-108.63s67.5 37.5 93.75 50 27.75 12.5 29.62 18c1.53 13.95.73 28.06-2.38 41.75-2.25 1.13-49.13-1.13-62.5 0s-17.37 19.88-16.37 27.38 1.62 10.88-1.5 13.25-45 13.63-47.25 25 29.62 67.13 25 68.75-57.13-2-69.63-14.87Z'
              style={{
                fill: '#4eae4d',
                strokeWidth: 0,
              }}
            />
            <path
              d='M53.87 224.96c3.29-15.66 8.15-30.94 14.5-45.62 6.25-9.38 9-11.37 11.75-10.63s10.5 4.38 9.75 6.63-14.13 28.12-17.62 39.5 0 11.37-5 12.5-11.75.38-13.37-2.38ZM411.87 105.09c2-1.75 31.62-9 33.62-6.25s4.25 5.5 2.25 7c-10.41 5.2-21.41 9.14-32.75 11.75-2.5-1.25-5.63-10.63-3.12-12.5ZM392.62 196.84c1.88 2 18.38 28.5 16.38 30.87s0 5.87-4.25 3.87a77.929 77.929 0 0 1-19.25-27.75c1.38-3.12 7.12-7 7.12-7ZM374.37 214.84c8.12 7.88 15.33 16.64 21.5 26.13 0 2.38 0 5.87-3.88 4.75-8.95-6.35-16.8-14.12-23.25-23 0-2 5.63-8.25 5.63-7.87ZM528.5 155.84c11.31 3 21.93 8.18 31.25 15.25 0 2.38 1.25 8.63-1.88 7.38s-31.75-12.5-32.88-14 3.12-8.25 3.5-8.63ZM525.75 185.21c1-1.38 50 27.25 50 31.63s4.37 7.38-.75 6.63a375.98 375.98 0 0 1-53.12-27c-1.5-2.38 2.5-9.38 3.88-11.25ZM521.12 210.21c21.29 8.7 41.58 19.68 60.5 32.75.75 3.5 3.5 7.38-1.5 7a505.786 505.786 0 0 1-61.75-29.63c-1.13-1.62 1.13-9.38 2.75-10.12ZM532.87 354.34a164.657 164.657 0 0 1 36.25 34.75c-1.13 3.12 0 4.62-3.5 3.5a279.752 279.752 0 0 1-39-34c.75-2 4.25-3.5 6.25-4.25ZM513.25 378.09a354.61 354.61 0 0 1 41.87 39.5c0 3.12-1.63 5.88-3.12 5.5a521.14 521.14 0 0 1-43-37.5c1.23-2.6 2.65-5.11 4.25-7.5ZM500.75 403.46a291.736 291.736 0 0 1 41.87 41.5c-.87 3.12.75 5-3.12 4.62a487.371 487.371 0 0 1-44.12-39.38c1.54-2.44 3.34-4.7 5.38-6.75ZM491 424.21a363.7 363.7 0 0 1 42.62 41c0 3.12-1.25 5.12-2.75 3.88a547.909 547.909 0 0 1-48-38.63c1.44-3.35 4.51-5.72 8.13-6.25ZM483.25 461.71a200.262 200.262 0 0 1 38.25 34c0 2.75-2 4.62-3.12 4.25a420.4 420.4 0 0 1-39.87-31.25c-.37-2.37 3.88-6.62 4.75-7ZM474.37 484.34c2.12 0 40.62 33.62 37.5 36.75s-1.5 4.62-4.62 3.5a279.18 279.18 0 0 1-39.13-33.62c1.38-1.88 4.13-6.62 6.25-6.62ZM351.62 453.09c1.13-1.75 16.38 3.88 16 7.5s0 4.25-2 4.25a62.53 62.53 0 0 1-19.12-5.5c0-1.5 4.25-5 5.12-6.25ZM326.12 501.21c4.63-2 9.87-2 14.5 0 5.88 2.75 14.5 12.5 22.25 13.75s13.75-3.5 15.62-2.37a4.625 4.625 0 0 1 2 5.88c-1.25 2-2 3.88-5.12 4.62a25.007 25.007 0 0 1-18.75-1.88c-7.25-4.87-11.75-11-19.75-11s-7.12 1.5-8.62 0-5.25-6.37-2.12-9ZM236.87 412.09c3.12 2 25.75 21.88 25 25s-2.38 6.25-4.75 5.5a126.131 126.131 0 0 1-26.87-22.75c-.13-3 6.63-7.75 6.63-7.75ZM214.5 290.59c1.5 0 35.12 52.37 32.38 55.12s-4.25 5.5-5.87 3.88a559.265 559.265 0 0 1-35.5-54.25c2.42-2.5 5.57-4.16 9-4.75ZM227.37 285.21c0-1.5 7.38-4.75 9.75-2.38a150.444 150.444 0 0 1 17.13 34c-1.13 2.25 0 5.88-3.12 3.5a220.5 220.5 0 0 1-23.75-35.12ZM296.12 281.59c1-1.38 12.5-12.5 16-12.5s12.5 0 11.37 2.75-17.62 23.87-20.75 21.88a20.786 20.786 0 0 1-6.63-12.12Z'
              style={{
                fill: '#1d1d1b',
                strokeWidth: 0,
              }}
            />
          </svg>{' '}
        </div>
      ))}
    </div>
  );
};

export default MatterDemo;
